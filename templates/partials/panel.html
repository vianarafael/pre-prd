<form id="panel-form">
  {% if tab == 'rules' %}
  <textarea
    name="rules_text"
    class="textarea textarea-bordered w-full mt-3 bg-background/50 border-primary/30 resize-y min-h-[18rem] md:min-h-[24rem] lg:min-h-[32rem] xl:min-h-[65vh] 2xl:min-h-[75vh]"
    placeholder="# Cursor Rules"
  >
{{ rules_text }}</textarea
  >
  <textarea name="script_text" class="hidden" aria-hidden="true">
{{ script_text }}</textarea
  >
  <input
    type="hidden"
    name="scenes_json"
    value='{{ scenes_json|default("[]")|e }}'
  />
  {% elif tab == 'scenes' %}
  <input type="hidden" name="script_text" value="{{ script_text|e }}" />
  <input type="hidden" name="rules_text" value="{{ rules_text|e }}" />
  <input
    type="hidden"
    name="scenes_json"
    value='{{ scenes_json|default("[]")|e }}'
  />

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3
        class="text-xl font-bold text-primary"
        style="font-family: var(--font-display, Inter)"
      >
        Scenes (Epics)
      </h3>
      <button
        class="btn btn-primary"
        hx-post="/panel?tab=scenes&op=add"
        hx-target="#panel"
        hx-swap="innerHTML"
        hx-include="#panel form"
      >
        Add Scene
      </button>
    </div>

    {% for scene in scenes_data %}
    <div
      class="bg-card/70 rounded-lg p-4 border {{ 'border-secondary/30' if editing_scene and editing_scene.id == scene.id else 'border-primary/20' }}"
    >
      {% if editing_scene and editing_scene.id == scene.id %}
      <div class="grid md:grid-cols-2 gap-3">
        <input
          type="hidden"
          name="original_id"
          value="{{ editing_scene.id }}"
        />
        <input
          name="edit_id"
          value="{{ editing_scene.id }}"
          class="input input-bordered w-full"
        />
        <input
          name="edit_title"
          value="{{ editing_scene.title }}"
          placeholder="Title"
          class="input input-bordered w-full"
        />
        <input
          name="edit_goal"
          value="{{ editing_scene.goal }}"
          placeholder="Goal"
          class="input input-bordered md:col-span-2 w-full"
        />
      </div>
      <div class="mt-3 flex gap-2 justify-end">
        <button
          class="btn"
          hx-post="/panel?tab=scenes&op=save"
          hx-target="#panel"
          hx-include="#panel form"
          hx-swap="innerHTML"
        >
          Save
        </button>
        <button
          class="btn btn-ghost"
          hx-post="/panel?tab=scenes"
          hx-target="#panel"
          hx-include="#panel form"
          hx-swap="innerHTML"
        >
          Cancel
        </button>
      </div>
      {% else %}
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">{{ scene.id }} — {{ scene.title }}</div>
          <div class="text-sm opacity-80">Goal: {{ scene.goal }}</div>
        </div>
        <div class="flex gap-2">
          <button
            class="btn btn-outline btn-xs"
            hx-post="/panel?tab=scenes&op=edit&id={{ scene.id }}"
            hx-target="#panel"
            hx-swap="innerHTML"
            hx-include="#panel form"
          >
            Edit
          </button>
          <button
            class="btn btn-outline btn-error btn-xs"
            hx-post="/panel?tab=scenes&op=delete&id={{ scene.id }}"
            hx-target="#panel"
            hx-swap="innerHTML"
            hx-include="#panel form"
          >
            Delete
          </button>
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  {% else %}
  {% if tab == 'shots' %}
  <input type="hidden" name="script_text" value="{{ script_text|e }}" />
  <input type="hidden" name="rules_text" value="{{ rules_text|e }}" />
  <input type="hidden" name="scenes_json" value='{{ scenes_json|default("[]")|e }}' />
  <input type="hidden" name="shots_json" value='{{ shots_json|default("[]")|e }}' />

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-bold text-primary" style="font-family: var(--font-display, Inter)">Shots (Tickets)</h3>
      <button class="btn btn-primary" hx-post="/panel?tab=shots&op=add" hx-target="#panel" hx-swap="innerHTML" hx-include="#panel form">New Shot</button>
    </div>

    {% for shot in shots_data %}
    <div class="bg-card/70 rounded-lg p-4 border {{ 'border-secondary/30' if editing_shot and editing_shot.id == shot.id else 'border-primary/20' }}">
      {% if editing_shot and editing_shot.id == shot.id %}
      <div class="space-y-3">
        <input type="hidden" name="shot_original_id" value="{{ editing_shot.id }}" />
        <div class="grid md:grid-cols-3 gap-3">
          <input name="shot_id" value="{{ editing_shot.id }}" class="input input-bordered w-full" />
          <input name="shot_epic_id" value="{{ editing_shot.epic_id }}" class="input input-bordered w-full" placeholder="Epic (E1)" />
          <input name="shot_title" value="{{ editing_shot.title }}" class="input input-bordered md:col-span-2 w-full" placeholder="Title" />
          <select name="shot_status" class="select select-bordered w-full">
            {% for s in ['todo','doing','done'] %}
            <option value="{{ s }}" {% if editing_shot.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
          <select name="shot_priority" class="select select-bordered w-full">
            {% for p in ['P1','P2','P3'] %}
            <option value="{{ p }}" {% if editing_shot.priority == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Description</span></label>
          <textarea name="shot_description" class="textarea textarea-bordered w-full" rows="3" placeholder="A few lines of text...">{{ editing_shot.description or '' }}</textarea>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold">Checklist</span>
            <button class="btn btn-sm" hx-post="/panel?tab=shots&op=add_check&id={{ editing_shot.id }}" hx-target="#panel" hx-include="#panel form" hx-swap="innerHTML">Add item</button>
          </div>
          <div class="space-y-2">
            {% set items = editing_shot.checklist or [] %}
            {% for item in items %}
            <div class="grid grid-cols-12 gap-2 items-center">
              <input class="col-span-8 input input-bordered" name="shot_check_text" value="{{ item.text }}" placeholder="Acceptance criterion" />
              <select class="col-span-3 select select-bordered" name="shot_check_tag">
                {% for t in ['positive','negative','error'] %}
                <option value="{{ t }}" {% if item.tag == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
              <button class="col-span-1 btn btn-outline btn-error" title="Remove" hx-post="/panel?tab=shots&op=remove_check&id={{ editing_shot.id }}&idx={{ loop.index0 }}" hx-target="#panel" hx-include="#panel form" hx-swap="innerHTML">×</button>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="mt-3 flex gap-2 justify-end">
          <button class="btn" hx-post="/panel?tab=shots&op=save" hx-target="#panel" hx-include="#panel form" hx-swap="innerHTML">Save</button>
          <button class="btn btn-ghost" hx-post="/panel?tab=shots" hx-target="#panel" hx-include="#panel form" hx-swap="innerHTML">Cancel</button>
        </div>
      </div>
      {% else %}
      <!-- Compact read card -->
      <div class="space-y-2">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-semibold truncate">{{ shot.title }}</div>
            <div class="text-xs opacity-80 truncate">Epic {{ shot.epic_id }} •
              <span class="inline-flex items-center gap-1">
                Status:
                <form hx-post="/panel?tab=shots&op=update_status&id={{ shot.id }}" hx-target="#panel" hx-include="#panel form" class="inline">
                  <select name="status" class="select select-xs select-bordered align-middle">
                    {% for s in ['todo','doing','done'] %}
                    <option value="{{ s }}" {% if shot.status == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                  </select>
                </form>
              </span>
              • Priority:
              <span class="badge badge-outline">{{ shot.priority }}</span>
            </div>
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="btn btn-outline btn-xs" hx-post="/panel?tab=shots&op=edit&id={{ shot.id }}" hx-target="#panel" hx-swap="innerHTML" hx-include="#panel form">Edit</button>
            <button class="btn btn-outline btn-error btn-xs" hx-post="/panel?tab=shots&op=delete&id={{ shot.id }}" hx-target="#panel" hx-swap="innerHTML" hx-include="#panel form">Delete</button>
          </div>
        </div>
        {% if shot.description %}
        <div class="text-sm opacity-90 line-clamp-3">{{ shot.description }}</div>
        {% endif %}
        {% if shot.checklist %}
        <div class="flex flex-wrap gap-2">
          {% for item in shot.checklist %}
          <span class="badge {{ 'badge-success' if item.tag == 'positive' else ('badge-warning' if item.tag == 'negative' else 'badge-error') }} badge-outline">{{ item.text }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <textarea
    name="script_text"
    class="textarea textarea-bordered w-full mt-3 bg-background/50 border-primary/30 resize-y min-h-[18rem] md:min-h-[24rem] lg:min-h-[32rem] xl:min-h-[65vh] 2xl:min-h-[75vh]"
    placeholder="FADE IN: Write your production script here..."
  >
{{ script_text }}</textarea
  >
  <textarea name="rules_text" class="hidden" aria-hidden="true">
{{ rules_text }}</textarea
  >
  <input
    type="hidden"
    name="scenes_json"
    value='{{ scenes_json|default("[]")|e }}'
  />
  <input
    type="hidden"
    name="shots_json"
    value='{{ shots_json|default("[]")|e }}'
  />
  {% endif %}
  {% endif %}
</form>


